<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Master - Galette des Rois</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/galette.css">
</head>
<body class="galette-body">
    <!-- Crown SVG Definition -->
    <svg style="display: none;">
        <defs>
            <linearGradient id="crown-gradient" x1="32" y1="8" x2="32" y2="46">
                <stop offset="0%" stop-color="#f7e98e"/>
                <stop offset="50%" stop-color="#d4af37"/>
                <stop offset="100%" stop-color="#996515"/>
            </linearGradient>
        </defs>
        <symbol id="crown-icon" viewBox="0 0 64 48">
            <path d="M4 38L12 14L24 26L32 6L40 26L52 14L60 38H4Z"
                  fill="url(#crown-gradient)"
                  stroke="#996515"
                  stroke-width="2"/>
            <circle cx="12" cy="12" r="4" fill="#f7e98e"/>
            <circle cx="32" cy="4" r="5" fill="#f7e98e"/>
            <circle cx="52" cy="12" r="4" fill="#f7e98e"/>
            <rect x="4" y="38" width="56" height="6" fill="#996515" rx="1"/>
        </symbol>
    </svg>

    <div class="container mx-auto px-4 py-8 max-w-4xl galette-shell">
        <div class="lg:flex lg:gap-6">
            <div class="flex-1">
                <!-- Header with Crown -->
                <div class="flex items-center justify-center gap-4 mb-8">
                    <svg class="crown-icon-small hidden sm:block" style="width: 40px; height: 30px;">
                        <use href="#crown-icon"/>
                    </svg>
                    <h1 class="text-2xl sm:text-3xl font-bold text-center">Galette des Rois Quiz</h1>
                    <svg class="crown-icon-small hidden sm:block" style="width: 40px; height: 30px;">
                        <use href="#crown-icon"/>
                    </svg>
                </div>

                <!-- Recovery Prompt View -->
                <div id="recovery-view" class="hidden text-center">
                    <div class="mb-8">
                        <svg class="mx-auto mb-6 winner-crown" style="width: 80px; height: 60px;">
                            <use href="#crown-icon"/>
                        </svg>
                        <p class="text-xl mb-4 text-gray-300">You have an active game!</p>
                        <p class="text-4xl font-bold tracking-widest text-purple-400 mb-2" id="recovery-game-code"></p>
                        <p class="text-gray-500 mb-6">Would you like to rejoin?</p>
                    </div>
                    <div class="flex gap-4 justify-center">
                        <button id="rejoin-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg text-xl">
                            Rejoin Game
                        </button>
                        <button id="new-game-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-8 rounded-lg text-xl">
                            Start New Game
                        </button>
                    </div>
                </div>

                <!-- Setup View -->
                <div id="setup-view" class="text-center">
                    <div class="mb-8">
                        <svg class="mx-auto mb-6 winner-crown" style="width: 80px; height: 60px;">
                            <use href="#crown-icon"/>
                        </svg>
                        <p class="text-xl mb-2 text-gray-400">Who will find the feve?</p>
                        <p class="text-lg text-gray-500">Create a quiz game and crown your champion</p>
                    </div>
                    <button id="create-game-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-lg text-xl">
                        Create Game
                    </button>

                    <div class="mt-8 pt-6 border-t border-gray-700">
                        <p class="text-gray-500 mb-4 text-sm">Already have a game code?</p>
                        <div class="flex gap-2 justify-center max-w-sm mx-auto">
                            <input type="text" id="manual-game-code" placeholder="ABCD" maxlength="4"
                                   class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-center text-2xl font-bold tracking-widest uppercase w-32 focus:border-purple-500 focus:outline-none">
                            <button id="manual-rejoin-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
                                Rejoin
                            </button>
                        </div>
                        <p id="rejoin-error" class="text-red-400 mt-2 hidden text-sm"></p>
                    </div>
                </div>

                <!-- Lobby View -->
                <div id="lobby-view" class="hidden">
                    <div class="bg-gray-800 rounded-lg p-6 mb-6 next-panel-cube">
                        <div class="text-center mb-6">
                            <p class="text-gray-400 mb-2 uppercase tracking-widest text-sm">Game Code</p>
                            <p id="game-code" class="text-5xl font-bold tracking-widest text-purple-400"></p>
                        </div>
                        <div class="text-center mb-2">
                            <p class="text-gray-400 mb-2 uppercase tracking-widest text-sm">Players join at</p>
                            <p id="join-url" class="text-xl text-blue-400 break-all font-mono"></p>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                            <span>Players</span>
                            <span class="text-gray-400">(<span id="player-count">0</span>)</span>
                        </h2>
                        <ul id="player-list" class="space-y-2"></ul>
                        <p id="no-players" class="text-gray-500 italic text-center py-4">Waiting for players to join...</p>
                    </div>

                    <button id="start-game-btn" class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold py-4 px-8 rounded-lg text-xl" disabled>
                        Start Game
                    </button>
                </div>

                <!-- Question View -->
                <div id="question-view" class="hidden">
                    <div class="bg-gray-800 rounded-lg p-6 mb-6">
                        <p class="text-gray-400 text-center mb-2 uppercase tracking-widest text-sm">
                            Question <span id="question-num">1</span> of <span id="total-questions">5</span>
                        </p>
                        <h2 id="question-text" class="text-xl sm:text-2xl font-semibold text-center mb-6 leading-relaxed question-text"></h2>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                            <div class="option-btn option-0 rounded-lg p-3 sm:p-4">
                                <span class="font-bold mr-2 shrink-0">A.</span><span id="option-0"></span>
                            </div>
                            <div class="option-btn option-1 rounded-lg p-3 sm:p-4">
                                <span class="font-bold mr-2 shrink-0">B.</span><span id="option-1"></span>
                            </div>
                            <div class="option-btn option-2 rounded-lg p-3 sm:p-4">
                                <span class="font-bold mr-2 shrink-0">C.</span><span id="option-2"></span>
                            </div>
                            <div class="option-btn option-3 rounded-lg p-3 sm:p-4">
                                <span class="font-bold mr-2 shrink-0">D.</span><span id="option-3"></span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-lg p-4 mb-6">
                        <p class="text-center text-lg">
                            <span class="text-gray-400">Answers:</span>
                            <span id="answer-count" class="font-bold text-green-400">0</span>
                            <span class="text-gray-500">/</span>
                            <span id="total-players">0</span>
                            <span class="mx-3 text-gray-600">|</span>
                            <span class="text-gray-400">Waiting:</span>
                            <span id="remaining-count" class="font-bold text-yellow-400">0</span>
                        </p>
                    </div>

                    <button id="reveal-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 px-8 rounded-lg text-xl">
                        Reveal Answer
                    </button>
                </div>

                <!-- Reveal Confirmation Modal -->
                <div id="reveal-confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
                    <div class="bg-gray-800 rounded-lg p-6 max-w-md mx-4">
                        <h3 class="text-xl font-bold text-yellow-400 mb-4">Not Everyone Has Answered!</h3>
                        <p class="text-gray-300 mb-4">The following players haven't answered yet:</p>
                        <ul id="unanswered-players-list" class="bg-gray-700 rounded p-3 mb-4 max-h-40 overflow-y-auto"></ul>
                        <p class="text-gray-400 mb-6">Do you still want to reveal the answer?</p>
                        <div class="flex gap-4">
                            <button id="confirm-reveal-btn" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg">
                                Yes, Reveal
                            </button>
                            <button id="cancel-reveal-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reveal View -->
                <div id="reveal-view" class="hidden">
                    <div class="bg-gray-800 rounded-lg p-6 mb-6">
                        <p class="text-gray-400 text-center mb-2 uppercase tracking-widest text-sm">
                            Question <span id="reveal-question-num">1</span> of <span id="reveal-total-questions">5</span>
                        </p>
                        <h2 id="reveal-question-text" class="text-xl sm:text-2xl font-semibold text-center mb-6 leading-relaxed question-text"></h2>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-6" id="reveal-options"></div>

                        <div class="text-center py-4 border-t border-gray-700">
                            <p class="text-gray-400 uppercase tracking-widest text-sm mb-2">Correct Answer</p>
                            <p id="correct-answer" class="text-green-400 font-bold text-2xl"></p>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-lg p-6 mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-center flex items-center justify-center gap-2">
                            <svg style="width: 24px; height: 18px;"><use href="#crown-icon"/></svg>
                            <span>Leaderboard</span>
                            <svg style="width: 24px; height: 18px;"><use href="#crown-icon"/></svg>
                        </h3>
                        <ol id="leaderboard" class="space-y-2"></ol>
                    </div>

                    <button id="next-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-xl">
                        Next Question
                    </button>
                </div>

                <!-- Game Over View -->
                <div id="gameover-view" class="hidden">
                    <div class="bg-gray-800 rounded-lg p-8 text-center mb-6">
                        <div class="winner-crown mb-4">
                            <svg class="mx-auto" style="width: 100px; height: 75px;">
                                <use href="#crown-icon"/>
                            </svg>
                        </div>
                        <h2 class="text-3xl font-bold mb-2 uppercase tracking-widest">The King</h2>
                        <p class="text-gray-400 mb-4 text-sm">Found the Feve!</p>
                        <p id="winner-name" class="text-5xl font-bold mb-4"></p>
                        <div class="inline-block px-4 py-2 bg-yellow-900 rounded-lg feve-found">
                            <span class="text-crown-gold">Champion of the Galette</span>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4 text-center uppercase tracking-widest">Final Rankings</h3>
                        <ol id="final-rankings" class="space-y-2"></ol>
                    </div>
                </div>
            </div>

            <!-- Stats Sidebar -->
            <aside id="stats-sidebar" class="hidden mt-8 lg:mt-0 lg:w-72 bg-gray-800 rounded-lg p-4">
                <!-- Disconnect warning banner -->
                <div id="disconnect-warning" class="hidden bg-yellow-500 text-black px-4 py-2 rounded-lg mb-4 font-semibold flex justify-between items-center">
                    <span id="disconnect-text">Someone disconnected</span>
                    <button onclick="dismissDisconnectWarning()" class="text-black/70 hover:text-black text-xl leading-none">&times;</button>
                </div>

                <!-- Game Code (persistent) -->
                <div class="mb-4 pb-4 border-b border-gray-700">
                    <p class="text-gray-400 text-sm uppercase tracking-widest">Game Code</p>
                    <p id="sidebar-game-code" class="text-2xl font-bold tracking-widest text-purple-400 mt-1"></p>
                </div>

                <div class="mb-6">
                    <p class="text-gray-400 text-sm uppercase tracking-widest">Group Score</p>
                    <p id="group-score" class="text-3xl font-bold mt-2">0 pts</p>
                </div>

                <div>
                    <p class="text-gray-400 text-sm uppercase tracking-widest mb-3">Player Stats</p>
                    <ul id="player-timing-list" class="space-y-2 hide-scrollbar max-h-96 overflow-y-auto"></ul>
                </div>
            </aside>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-6 text-gray-500 text-sm">
        <p>made with ‚ù§ at casa utah by Lulu & Rohan</p>
    </footer>

    <script>
        let ws = null;
        let gameCode = null;
        let currentQuestion = null;
        let currentQuestionIndex = null;
        let latestPlayers = [];

        // DOM Elements
        const recoveryView = document.getElementById('recovery-view');
        const setupView = document.getElementById('setup-view');
        const lobbyView = document.getElementById('lobby-view');
        const questionView = document.getElementById('question-view');
        const revealView = document.getElementById('reveal-view');
        const gameoverView = document.getElementById('gameover-view');

        // Setup event listeners
        document.getElementById('create-game-btn').addEventListener('click', createGame);
        document.getElementById('start-game-btn').addEventListener('click', () => sendMessage({ type: 'start_game' }));
        document.getElementById('reveal-btn').addEventListener('click', handleRevealClick);
        document.getElementById('next-btn').addEventListener('click', () => sendMessage({ type: 'next_question' }));

        // Reveal confirmation modal handlers
        document.getElementById('confirm-reveal-btn').addEventListener('click', () => {
            document.getElementById('reveal-confirm-modal').classList.add('hidden');
            sendMessage({ type: 'reveal_answer' });
        });
        document.getElementById('cancel-reveal-btn').addEventListener('click', () => {
            document.getElementById('reveal-confirm-modal').classList.add('hidden');
        });

        // Recovery event listeners
        document.getElementById('rejoin-btn').addEventListener('click', () => rejoinGame(localStorage.getItem('quizMasterGameCode')));
        document.getElementById('new-game-btn').addEventListener('click', () => {
            localStorage.removeItem('quizMasterGameCode');
            showView('setup');
        });
        document.getElementById('manual-rejoin-btn').addEventListener('click', () => {
            const code = document.getElementById('manual-game-code').value.toUpperCase().trim();
            if (code.length === 4) {
                rejoinGame(code);
            } else {
                showRejoinError('Please enter a 4-letter code');
            }
        });
        document.getElementById('manual-game-code').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('manual-rejoin-btn').click();
            }
        });

        // Check for saved game on page load
        checkForSavedGame();

        async function createGame() {
            const response = await fetch('/api/create-game', { method: 'POST' });
            const data = await response.json();
            gameCode = data.code;

            // Save game code to localStorage for recovery after refresh
            localStorage.setItem('quizMasterGameCode', gameCode);

            document.getElementById('game-code').textContent = gameCode;
            document.getElementById('sidebar-game-code').textContent = gameCode;
            document.getElementById('join-url').textContent = `http://${data.local_ip}:8000/play`;

            showView('lobby');
            connectWebSocket();
        }

        async function checkForSavedGame() {
            const savedCode = localStorage.getItem('quizMasterGameCode');
            if (!savedCode) {
                showView('setup');
                return;
            }

            // Verify the game still exists
            try {
                const response = await fetch(`/api/game/${savedCode}`);
                const data = await response.json();

                if (data.error) {
                    // Game no longer exists, clear localStorage
                    localStorage.removeItem('quizMasterGameCode');
                    showView('setup');
                    return;
                }

                // Game exists - show recovery prompt
                document.getElementById('recovery-game-code').textContent = savedCode;
                showView('recovery');
            } catch (e) {
                // Error checking game - clear localStorage and show setup
                localStorage.removeItem('quizMasterGameCode');
                showView('setup');
            }
        }

        async function rejoinGame(code) {
            if (!code) {
                showRejoinError('No game code provided');
                return;
            }

            code = code.toUpperCase();

            // Verify the game exists
            try {
                const response = await fetch(`/api/game/${code}`);
                const data = await response.json();

                if (data.error) {
                    showRejoinError('Game not found');
                    localStorage.removeItem('quizMasterGameCode');
                    return;
                }

                // Game exists - connect to it
                gameCode = code;
                localStorage.setItem('quizMasterGameCode', gameCode);

                // Set up the UI with game info
                document.getElementById('game-code').textContent = gameCode;
                document.getElementById('join-url').textContent = `http://${data.local_ip || window.location.hostname}:8000/play`;

                connectWebSocket();
            } catch (e) {
                showRejoinError('Failed to connect to game');
            }
        }

        function showRejoinError(message) {
            const errorEl = document.getElementById('rejoin-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 3000);
        }

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/ws/master/${gameCode}`);

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };

            ws.onclose = (event) => {
                console.log('WebSocket closed', event.code);
                // Code 4004 means game not found
                if (event.code === 4004) {
                    localStorage.removeItem('quizMasterGameCode');
                    showRejoinError('Game not found');
                    showView('setup');
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function sendMessage(msg) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(msg));
            }
        }

        function handleRevealClick() {
            const unansweredPlayers = latestPlayers.filter(p => p.connected !== false && !p.has_answered);

            if (unansweredPlayers.length === 0) {
                // Everyone answered, reveal immediately
                sendMessage({ type: 'reveal_answer' });
            } else {
                // Show confirmation modal with unanswered player names
                const list = document.getElementById('unanswered-players-list');
                list.innerHTML = unansweredPlayers.map(p =>
                    `<li class="text-yellow-400 py-1">${p.name}</li>`
                ).join('');
                document.getElementById('reveal-confirm-modal').classList.remove('hidden');
            }
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'error':
                    console.error('Game error:', msg.message);
                    if (msg.message === 'Game not found') {
                        localStorage.removeItem('quizMasterGameCode');
                        showRejoinError('Game not found');
                        showView('setup');
                    }
                    break;

                case 'game_state':
                    updatePlayerList(msg.players);
                    updateStatsPanel(msg.players);
                    currentQuestionIndex = msg.current_question_index ?? null;
                    document.getElementById('total-questions').textContent = msg.question_count;
                    document.getElementById('reveal-total-questions').textContent = msg.question_count;

                    // Show the correct view based on game phase
                    if (msg.phase === 'lobby') {
                        showView('lobby');
                    } else if (msg.phase === 'question') {
                        // Will be shown when question message arrives
                        showView('question');
                    } else if (msg.phase === 'reveal') {
                        showView('reveal');
                    } else if (msg.phase === 'finished') {
                        showView('gameover');
                    }
                    break;

                case 'player_list':
                    updatePlayerList(msg.players);
                    updateStatsPanel(msg.players);
                    break;

                case 'question':
                    showQuestion(msg);
                    break;

                case 'answer_received':
                    document.getElementById('answer-count').textContent = msg.answered_count;
                    document.getElementById('total-players').textContent = msg.total_players;
                    document.getElementById('remaining-count').textContent = msg.remaining_count;
                    if (msg.players) {
                        updateStatsPanel(msg.players);
                    } else {
                        updateStatsPanel();
                    }
                    break;

                case 'reveal':
                    showReveal(msg);
                    updateStatsPanel();
                    break;

                case 'game_over':
                    showGameOver(msg);
                    updateStatsPanel();
                    // Clear localStorage since game is finished
                    localStorage.removeItem('quizMasterGameCode');
                    break;

                case 'player_disconnected':
                    showDisconnectWarning(msg.player_name);
                    break;
            }
        }

        function showDisconnectWarning(playerName) {
            const warning = document.getElementById('disconnect-warning');
            const text = document.getElementById('disconnect-text');
            text.textContent = `${playerName} disconnected`;
            warning.classList.remove('hidden');
        }

        function dismissDisconnectWarning() {
            document.getElementById('disconnect-warning').classList.add('hidden');
        }

        function updatePlayerList(players) {
            const list = document.getElementById('player-list');
            const noPlayers = document.getElementById('no-players');
            const startBtn = document.getElementById('start-game-btn');
            const connectedPlayers = players.filter(p => p.connected !== false);

            document.getElementById('player-count').textContent = players.length;

            if (players.length === 0) {
                list.innerHTML = '';
                noPlayers.classList.remove('hidden');
                startBtn.disabled = true;
            } else {
                noPlayers.classList.add('hidden');
                startBtn.disabled = connectedPlayers.length === 0;
                list.innerHTML = players.map((p, i) =>
                    `<li class="bg-gray-700 rounded p-3 flex justify-between items-center stagger-item ${p.connected === false ? 'opacity-60' : ''}"
                         style="animation-delay: ${i * 0.05}s">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 rounded bg-gray-600 flex items-center justify-center font-bold text-sm">${p.name.charAt(0).toUpperCase()}</span>
                            <span>${p.name}${p.connected === false ? ' <span class="text-gray-500 text-sm">(offline)</span>' : ''}</span>
                        </div>
                        <span class="text-gray-400 font-mono">${p.score} pts</span>
                    </li>`
                ).join('');
            }
        }

        function updateStatsPanel(players) {
            if (players) {
                latestPlayers = players;
            }

            const sidebar = document.getElementById('stats-sidebar');
            if (!sidebar) return;

            const groupScore = latestPlayers.reduce((sum, p) => sum + (p.score || 0), 0);
            const groupScoreEl = document.getElementById('group-score');
            if (groupScoreEl) {
                groupScoreEl.textContent = `${groupScore} pts`;
            }

            const list = document.getElementById('player-timing-list');
            if (!list) return;

            const sortedPlayers = [...latestPlayers].sort((a, b) => {
                const scoreDiff = (b.score || 0) - (a.score || 0);
                if (scoreDiff !== 0) return scoreDiff;
                const aTime = a.avg_answer_time !== null && a.avg_answer_time !== undefined ? a.avg_answer_time : Infinity;
                const bTime = b.avg_answer_time !== null && b.avg_answer_time !== undefined ? b.avg_answer_time : Infinity;
                if (aTime !== bTime) return aTime - bTime;
                return (a.name || '').localeCompare(b.name || '');
            });

            list.innerHTML = sortedPlayers.map((p, i) => {
                const lastTime = p.last_answer_time !== null && p.last_answer_time !== undefined
                    ? `${p.last_answer_time.toFixed(2)}s`
                    : '--';
                const lastQ = p.last_answer_question_index !== null && p.last_answer_question_index !== undefined
                    ? `Q${p.last_answer_question_index + 1}`
                    : '';
                const isCurrent = currentQuestionIndex !== null && p.last_answer_question_index === currentQuestionIndex;
                const status = p.connected === false
                    ? 'Offline'
                    : (p.has_answered ? 'Answered' : 'Waiting');
                const statusColor = p.connected === false
                    ? 'text-gray-500'
                    : (p.has_answered ? 'text-green-400' : 'text-yellow-400');
                const medal = i === 0 ? '<span class="text-yellow-400">1st</span>' :
                              i === 1 ? '<span class="text-gray-400">2nd</span>' :
                              i === 2 ? '<span class="text-orange-400">3rd</span>' :
                              `<span class="text-gray-500">${i + 1}th</span>`;

                return `<li class="bg-gray-700 rounded p-3 stagger-item" style="animation-delay: ${i * 0.05}s">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            ${medal}
                            <span class="font-semibold">${p.name}</span>
                        </div>
                        <span class="font-bold text-crown-gold">${p.score} pts</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="${statusColor}">${status}</span>
                        <span class="text-gray-500">${isCurrent ? 'This Q' : lastQ} ${lastTime}</span>
                    </div>
                </li>`;
            }).join('');
        }

        function showQuestion(msg) {
            currentQuestion = msg;
            if (msg.question_index !== undefined) {
                currentQuestionIndex = msg.question_index;
            } else {
                currentQuestionIndex = msg.question_number - 1;
            }
            document.getElementById('question-num').textContent = msg.question_number;
            document.getElementById('question-text').textContent = msg.text;
            document.getElementById('answer-count').textContent = msg.answered_count !== undefined ? msg.answered_count : '0';
            document.getElementById('total-players').textContent = msg.total_players !== undefined ? msg.total_players : '0';
            document.getElementById('remaining-count').textContent = msg.remaining_count !== undefined ? msg.remaining_count : '0';

            msg.options.forEach((opt, i) => {
                document.getElementById(`option-${i}`).textContent = opt;
            });

            // Reset option styles
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('correct');
            });

            updateStatsPanel();
            showView('question');
        }

        function showReveal(msg) {
            const questionNumber = msg.question_number ?? (currentQuestion ? currentQuestion.question_number : null);
            const questionText = msg.text ?? (currentQuestion ? currentQuestion.text : '');
            const questionOptions = Array.isArray(msg.options)
                ? msg.options
                : (currentQuestion ? currentQuestion.options : []);

            if (msg.question_index !== undefined && msg.question_index !== null) {
                currentQuestionIndex = msg.question_index;
            }
            if (msg.total_questions !== undefined && msg.total_questions !== null) {
                document.getElementById('reveal-total-questions').textContent = msg.total_questions;
            }

            if (questionNumber !== null) {
                document.getElementById('reveal-question-num').textContent = questionNumber;
            }
            document.getElementById('reveal-question-text').textContent = questionText;
            currentQuestion = {
                question_number: questionNumber,
                text: questionText,
                options: questionOptions,
            };
            document.getElementById('correct-answer').textContent = msg.correct_answer;

            // Show options with correct highlighted
            const optionsHtml = questionOptions.map((opt, i) => {
                const isCorrect = i === msg.correct_index;
                return `<div class="option-btn option-${i} rounded-lg p-3 sm:p-4 ${isCorrect ? 'correct' : 'opacity-40'}">
                    <span class="font-bold mr-2 shrink-0">${['A', 'B', 'C', 'D'][i]}.</span>${opt}
                </div>`;
            }).join('');
            document.getElementById('reveal-options').innerHTML = optionsHtml;

            // Update leaderboard
            const leaderboard = document.getElementById('leaderboard');
            leaderboard.innerHTML = msg.rankings.map((p, i) => {
                const medal = i === 0 ? '<svg style="width: 20px; height: 15px; display: inline-block; vertical-align: middle;"><use href="#crown-icon"/></svg>' :
                              i === 1 ? '<span class="text-gray-300">2nd</span>' :
                              i === 2 ? '<span class="text-orange-400">3rd</span>' : '';
                return `<li class="bg-gray-700 rounded p-3 flex justify-between items-center stagger-item" style="animation-delay: ${i * 0.05}s">
                    <span class="flex items-center gap-2">${medal} <span class="${i === 0 ? 'font-bold' : ''}">${i + 1}. ${p.name}</span></span>
                    <span class="font-bold ${i === 0 ? 'text-yellow-400' : ''}">${p.score} pts</span>
                </li>`;
            }).join('');

            showView('reveal');
        }

        function showGameOver(msg) {
            document.getElementById('winner-name').textContent = msg.winner;

            const rankings = document.getElementById('final-rankings');
            rankings.innerHTML = msg.final_rankings.map((p, i) => {
                const medal = i === 0 ? '<svg style="width: 28px; height: 21px; display: inline-block; vertical-align: middle;"><use href="#crown-icon"/></svg>' :
                              i === 1 ? '<span class="text-2xl">2nd</span>' :
                              i === 2 ? '<span class="text-2xl text-orange-400">3rd</span>' : '';
                return `<li class="bg-gray-700 rounded p-4 flex justify-between items-center stagger-item ${i === 0 ? 'bg-yellow-900 feve-found' : ''}"
                            style="animation-delay: ${i * 0.08}s">
                    <span class="flex items-center gap-3 text-xl">
                        ${medal}
                        <span class="${i === 0 ? 'font-bold' : ''}">${p.rank}. ${p.name}</span>
                    </span>
                    <span class="font-bold text-xl ${i === 0 ? 'text-yellow-400' : ''}">${p.score} pts</span>
                </li>`;
            }).join('');

            showView('gameover');
        }

        function showView(view) {
            recoveryView.classList.add('hidden');
            setupView.classList.add('hidden');
            lobbyView.classList.add('hidden');
            questionView.classList.add('hidden');
            revealView.classList.add('hidden');
            gameoverView.classList.add('hidden');

            document.getElementById(`${view}-view`).classList.remove('hidden');

            const sidebar = document.getElementById('stats-sidebar');
            if (sidebar) {
                if (view === 'setup' || view === 'recovery') {
                    sidebar.classList.add('hidden');
                } else {
                    sidebar.classList.remove('hidden');
                }
            }
        }
    </script>
</body>
</html>
